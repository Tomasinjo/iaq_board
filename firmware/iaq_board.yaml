# This YAML configuratrion in compatible with ESPHome 1.16.0

esphome:
  name: iaq_board
  platform: ESP32
  board: wemos_d1_mini32
  # The library dep is added because of a bug in the neopixel library 
  # ver. 2.5.7. Can be removed when library is updated in future ver.
  # of esphome
  platformio_options:
    lib_deps: NeoPixelBus@2.6.0
  on_boot:
    then:
      - lambda: 'id(co2).publish_state(400);'
      - delay: 1 min
      - script.execute: min_max_zero_script
        
script:
  - id: min_max_zero_script
    then: 
      - globals.set:
          id: co_max
          value: '0.0'
      - globals.set:
          id: co_min
          value: '5000.0'
      - globals.set:
          id: temp_min
          value: '50.0'
      - globals.set:
          id: temp_max
          value: '0.0'

wifi:
#  networks: !include wifi/wifi.yaml
  ap:
    ssid: "iaq_board"
    password: "12345678"

captive_portal:

logger:
  baud_rate: 0
  
web_server:
  port: 80

api:
  reboot_timeout: 0s

ota:

substitutions:
  yaml_version: "1.1.3"

globals:
  - id: version
    type: bool
    initial_value: 'false'
  - id: co_min
    type: float
    initial_value: '5000.0'
  - id: co_max
    type: float
    initial_value: '0.0'
  - id: temp_min
    type: float
    initial_value: '50.0'
  - id: temp_max
    type: float
    initial_value: '0.0'
  - id: min_max_zero
    type: bool
    initial_value: 'false'

uart:
  - rx_pin: GPIO18
    tx_pin: GPIO19
    baud_rate: 9600
    id: mh

i2c:
  scl: GPIO22
  sda: GPIO21
  frequency: 100kHz

sensor:
    - platform: bme280
      temperature:
        name: "Temperature"
        oversampling: 1x
        id: temp
        filters:
          - offset: -1.5
        on_value:
          - lambda: |-
              if(id(temp).state > id(temp_max)) { id(temp_max) = id(temp).state; }
              if(id(temp).state < id(temp_min)) { id(temp_min) = id(temp).state; }
      pressure:
        name: "Pressure"
        oversampling: 1x
        id: press
      humidity:
        name: "Humidity"
        oversampling: 1x
        id: hum
      address: 0x76
      update_interval: 10s
      
    - platform: mhz19
      co2:
        name: "CO2"
        id: co2
      temperature:
        name: "MH-Z19 Temperature"
      update_interval: 10s
      automatic_baseline_calibration: false
      uart_id: mh
      id: mh_sensor
      
    - platform: tsl2561
      name: "Ambient Light"
      update_interval: 3s
      id: light_sens
      
    - platform: sgp30
      eco2:
        name: "eCO2"
        accuracy_decimals: 1
        id: eco2
      tvoc:
        name: "TVOC"
        accuracy_decimals: 1
        id: tvoc
      update_interval: 1s
      # https://esphome.io/components/sensor/sgp30.html#calibrating-baseline
      # baseline:
      #   eco2_baseline: 0x92B7
      #   tvoc_baseline: 0x935A
      compensation:
         temperature_source: temp
         humidity_source: hum
      
    - platform: uptime
      name: Uptime
      id: utime

text_sensor:
  - platform: wifi_info
    ip_address:
      name: IP Address
      id: ip
    ssid:
      name: Connected SSID
      id: ssid
      
  - platform: template
    name: "Air Quality Index (AQI)"
    id: aqi
    icon: mdi:air-filter
